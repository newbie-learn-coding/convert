name: Cloudflare CI/CD (Least Privilege)

on:
  pull_request:
    branches: ["master"]
  push:
    branches: ["master"]
  workflow_dispatch:
    inputs:
      target_env:
        description: "Cloudflare target environment"
        required: true
        default: production
        type: choice
        options:
          - production
          - staging

permissions:
  contents: read

concurrency:
  group: cloudflare-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    name: Verify (no secrets)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.3"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          corepack prepare pnpm@10.27.0 --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Production readiness gates (canonical + deploy)
        run: bun run validate:production-readiness

  deploy:
    name: Deploy to Cloudflare
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event_name == 'workflow_dispatch' && inputs.target_env || 'production' }}
    env:
      TARGET_ENV: ${{ github.event_name == 'workflow_dispatch' && inputs.target_env || 'production' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.3"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          corepack prepare pnpm@10.27.0 --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Guard required deploy secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "::error::Missing required GitHub secret: CLOUDFLARE_API_TOKEN"
            exit 1
          fi
          if [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "::error::Missing required GitHub secret: CLOUDFLARE_ACCOUNT_ID"
            exit 1
          fi

      - name: Prepare Wrangler runtime config from template
        run: cp wrangler.toml.example wrangler.toml

      - name: Deploy
        id: deploy_step
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_APP_VERSION: ${{ github.ref_name }}-${{ github.run_number }}
          CF_BUILD_SHA: ${{ github.sha }}
        run: bash scripts/deploy.sh "${TARGET_ENV}"

      - name: Post-deploy production ops gate
        id: post_deploy_gate
        if: env.TARGET_ENV == 'production'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_DEPLOY_BASE_URL: https://converttoit.com
        run: bash scripts/cf-post-deploy-gate.sh production --base-url "$CF_DEPLOY_BASE_URL"

      - name: Rollback production deploy on post-deploy gate failure
        if: ${{ always() && env.TARGET_ENV == 'production' && steps.deploy_step.outcome == 'success' && steps.post_deploy_gate.outcome == 'failure' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bash scripts/cf-rollback.sh production --yes
