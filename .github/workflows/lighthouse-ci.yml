name: Lighthouse CI

on:
  pull_request:
    branches: ["master"]
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.3"

      - name: Install dependencies
        run: bun i --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Serve static build for Lighthouse
        run: |
          bunx --bun serve-dist -l 8080 &
          sleep 5

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            http://localhost:8080/
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: Assert performance budgets
        run: |
          # Install lhci if not available
          bun pm add -g @lhci/cli
          
          # Assert against performance budgets
          lhci autorun --assert.html=false || {
            echo "::warning::Lighthouse CI assertions failed. Review the report above."
            exit 1
          }
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = '.lighthouseci/manifest.json';
            
            if (!fs.existsSync(resultsPath)) {
              console.log('No Lighthouse results found');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            const summary = results[0]?.summary;
            
            if (!summary) {
              console.log('No summary found in results');
              return;
            }
            
            const formatScore = (score) => Math.round(score * 100);
            const formatMetric = (value) => Math.round(value);
            
            const comment = `## Lighthouse Performance Report
            
            | Metric | Score | Value | Status |
            |--------|-------|-------|--------|
            | Performance | ${formatScore(summary.performance)}/100 | - | ${summary.performance >= 0.9 ? '✅ Pass' : summary.performance >= 0.5 ? '⚠️ Warn' : '❌ Fail'} |
            | Accessibility | ${formatScore(summary.accessibility)}/100 | - | ${summary.accessibility >= 0.9 ? '✅' : '❌'} |
            | Best Practices | ${formatScore(summary['best-practices'])}/100 | - | ${summary['best-practices'] >= 0.9 ? '✅' : '❌'} |
            | SEO | ${formatScore(summary.seo)}/100 | - | ${summary.seo >= 0.9 ? '✅' : '❌'} |
            | PWA | ${formatScore(summary.pwa)}/100 | - | ${summary.pwa >= 0.9 ? '✅' : '❌'} |
            
            ### Core Web Vitals
            
            | Metric | Value | Budget | Status |
            |--------|-------|--------|--------|
            | LCP | ${formatMetric(summary['largest-contentful-paint'])}ms | 2500ms | ${summary['largest-contentful-paint'] <= 2500 ? '✅ Pass' : '❌ Fail'} |
            | FID | ${formatMetric(summary['total-blocking-time'] / 10)}ms | 100ms | ${summary['total-blocking-time'] / 10 <= 100 ? '✅ Pass' : '❌ Fail'} |
            | CLS | ${summary['cumulative-layout-shift'].toFixed(3)} | 0.1 | ${summary['cumulative-layout-shift'] <= 0.1 ? '✅ Pass' : '❌ Fail'} |
            
            *Generated by Lighthouse CI*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
