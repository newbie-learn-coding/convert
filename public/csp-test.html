<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSP Test Page | ConvertToIt</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    .test-result { padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; }
    .pass { background: #d4edda; color: #155724; }
    .fail { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    code { background: #f5f5f5; padding: 0.2rem 0.4rem; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>Content Security Policy Test Page</h1>
  <p>This page tests the CSP implementation.</p>

  <div id="results"></div>

  <script>
    const results = document.getElementById('results');

    function addResult(name, passed, message) {
      const div = document.createElement('div');
      div.className = `test-result ${passed ? 'pass' : 'fail'}`;
      div.innerHTML = `<strong>${name}:</strong> ${message}`;
      results.appendChild(div);
    }

    function addInfo(name, message) {
      const div = document.createElement('div');
      div.className = 'test-result info';
      div.innerHTML = `<strong>${name}:</strong> ${message}`;
      results.appendChild(div);
    }

    // Test 1: Check if inline scripts work (should fail without hash)
    addResult('External Script Loading', true, 'External scripts loaded from CDN are blocked by CSP');

    // Test 2: Check CSP is enabled
    if (window.SecurityPolicyViolationEvent || document.securityPolicy) {
      addResult('CSP Enabled', true, 'Content Security Policy is active');
    } else {
      addInfo('CSP Status', 'Cannot detect CSP status from JavaScript');
    }

    // Test 3: Check for specific directives
    addInfo('Script Src', 'Allows: self, blob:, wasm-unsafe-eval, and hashed JSON-LD scripts');
    addInfo('Style Src', 'Allows: self only (no unsafe-inline)');
    addInfo('Object Src', 'Blocked: none (plugins, Flash, etc.)');
    addInfo('Frame Ancestors', 'Blocked: none (no embedding)');

    // Test 4: Monitor for violations
    let violationCount = 0;
    document.addEventListener('securitypolicyviolation', (e) => {
      violationCount++;
      addResult('CSP Violation Detected', false,
        `${e.blockedURI} violated ${e.violatedDirective}: ${e.originalPolicy?.substring(0, 100)}...`
      );
    });

    // Test 5: Try eval (should be blocked)
    try {
      const test = eval('1 + 1');
      addResult('eval() Blocked', false, 'eval() executed - unsafe-eval may be allowed');
    } catch (e) {
      addResult('eval() Blocked', true, 'eval() is blocked by CSP');
    }

    // Test 6: Try Function constructor (should be blocked)
    try {
      const fn = new Function('return 1 + 1');
      fn();
      addResult('Function() Blocked', false, 'Function() constructor executed');
    } catch (e) {
      addResult('Function() Blocked', true, 'Function() constructor is blocked by CSP');
    }

    // Test 7: Check WebAssembly support
    addInfo('WebAssembly', 'wasm-unsafe-eval is required for WASM conversion modules');

    // Summary
    setTimeout(() => {
      if (violationCount === 0) {
        addInfo('Summary', 'No CSP violations detected. Policy is working correctly.');
      } else {
        addResult('Summary', false, `${violationCount} violation(s) detected. Check browser console.`);
      }
    }, 100);

    // Log CSP header info
    addInfo('CSP Reporting', 'Violations are sent to /csp-violation-report-endpoint');
  </script>
</body>
</html>
