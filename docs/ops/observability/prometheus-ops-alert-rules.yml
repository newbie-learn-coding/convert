groups:
  - name: converttoit_ops_slo
    interval: 30s
    rules:
      - alert: ConverttoitOpsAvailabilityLow
        expr: |
          (
            sum(rate(converttoit_ops_requests_total{endpoint=~"/_ops/(health|version|metrics|log-ping)",status_code=~"2..|3.."}[5m]))
            /
            clamp_min(sum(rate(converttoit_ops_requests_total{endpoint=~"/_ops/(health|version|metrics|log-ping)"}[5m])), 1)
          ) < 0.999
        for: 10m
        labels:
          severity: p1
          service: converttoit-ops
          slo: availability
        annotations:
          summary: "/_ops availability dropped below 99.9%"
          description: "5-minute availability is below target for 10 minutes."
          runbook: "docs/ops/ops-slo-observability.md"

      - alert: ConverttoitOpsLatencyP95High
        expr: |
          histogram_quantile(
            0.95,
            sum by (le) (
              rate(converttoit_ops_request_duration_seconds_bucket{endpoint=~"/_ops/(health|version|metrics|log-ping)"}[5m])
            )
          ) > 0.3
        for: 10m
        labels:
          severity: p1
          service: converttoit-ops
          slo: latency
        annotations:
          summary: "/_ops p95 latency above 300ms"
          description: "p95 latency has exceeded 300ms for 10 minutes."
          runbook: "docs/ops/ops-slo-observability.md"

      - alert: ConverttoitOpsErrorRateHigh
        expr: |
          (
            sum(rate(converttoit_ops_requests_total{endpoint=~"/_ops/(health|version|metrics|log-ping)",status_code=~"5.."}[5m]))
            /
            clamp_min(sum(rate(converttoit_ops_requests_total{endpoint=~"/_ops/(health|version|metrics|log-ping)"}[5m])), 1)
          ) > 0.01
        for: 10m
        labels:
          severity: p1
          service: converttoit-ops
          slo: error_rate
        annotations:
          summary: "/_ops 5xx error rate above 1%"
          description: "5-minute 5xx ratio is above 1% for 10 minutes."
          runbook: "docs/ops/ops-slo-observability.md"

      - alert: ConverttoitOpsRateLimitedHigh
        expr: |
          (
            sum(rate(converttoit_ops_rejections_total{endpoint=~"/_ops/(health|version|metrics|log-ping)",reason="rate_limited"}[5m]))
            /
            clamp_min(sum(rate(converttoit_ops_requests_total{endpoint=~"/_ops/(health|version|metrics|log-ping)"}[5m])), 1)
          ) > 0.02
        for: 15m
        labels:
          severity: p2
          service: converttoit-ops
          slo: rate_limit
        annotations:
          summary: "/_ops rate-limit impact above 2%"
          description: "429 share is above 2% for 15 minutes; investigate limits or traffic spikes."
          runbook: "docs/ops/ops-slo-observability.md"
